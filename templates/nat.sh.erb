#!/bin/bash
# Configures nat instance iptable routing

# Enable for debugging
#set -x

# Common functions
[ -e /usr/local/lib/nubis/nubis-lib.sh ] && . /usr/local/lib/nubis/nubis-lib.sh || exit 1

# This variable is generated by puppet
NAT_IN_INTERFACE="<%= @nat_in_interface %>"
NAT_OUT_INTERFACE="<%= @nat_out_interface %>"

REGION=$(get_region)

log "Beginning Port Address Translator (PAT) configuration..."
log "Determining the MAC address on ${NAT_OUT_INTERFACE}..."
ETH_OUT_MAC=$(__get_mac ${NAT_OUT_INTERFACE}) ||
    die "Unable to determine MAC address on ${NAT_OUT_INTERFACE}."
log "Found MAC ${ETH_OUT_MAC} for ${NAT_OUT_INTERFACE}."

ETH_IN_MAC=$(__get_mac ${NAT_IN_INTERFACE}) ||
    die "Unable to determin MAC address on ${NAT_IN_INTERFACE}."
log "Found MAC ${ETH_IN_MAC} for ${NAT_IN_INTERFACE}."

VPC_CIDR_URI="http://169.254.169.254/latest/meta-data/network/interfaces/macs/${ETH_OUT_MAC}/vpc-ipv4-cidr-block"
log "Metadata location for vpc ipv4 range: ${VPC_CIDR_URI}"

VPC_CIDR_RANGE=$(curl --retry 3 --silent --fail ${VPC_CIDR_URI})
if [ $? -ne 0 ]; then
    log "Unable to retrive VPC CIDR range from meta-data, using 0.0.0.0/0 instead. PAT may be insecure!"
    VPC_CIDR_RANGE="0.0.0.0/0"
else
    log "Retrieved VPC CIDR range ${VPC_CIDR_RANGE} from meta-data."
fi

log "Enabling PAT..."
sysctl -q -p /etc/sysctl.d/01-nat-sysctl.cfg && (
    iptables -t nat -C POSTROUTING -o ${NAT_OUT_INTERFACE} -s ${VPC_CIDR_RANGE} -j MASQUERADE -m comment --comment "000 snat for network ${VPC_CIDR_RANGE}" 2> /dev/null ||
    iptables -t nat -A POSTROUTING -o ${NAT_OUT_INTERFACE} -s ${VPC_CIDR_RANGE} -j MASQUERADE -m comment --comment "000 snat for network ${VPC_CIDR_RANGE}" ) ||
        die

# Some debugging output here
log "$(sysctl net.ipv4.ip_forward)"
log "$(sysctl net.ipv4.conf.all.send_redirects)"
log "$(iptables -n -t nat -L POSTROUTING)"

# Disable source destination check else this breaks nat
ENI_IN_ID=$(get_eni_id "${NAT_IN_INTERFACE}")
ENI_OUT_ID=$(get_eni_id "${NAT_OUT_INTERFACE}")
for eni in ${ENI_IN_ID} ${ENI_OUT_ID}; do
    log "Disabling SourceDestCheck for eni: ${eni}"
    SOURCEDEST_CHECK=$(aws ec2 describe-network-interfaces --network-interface-ids "${eni}" --query 'NetworkInterfaces[].SourceDestCheck' --region "${REGION}" --output text)

    # This needs to happen otherwise the NAT will not work
    if [[ "${SOURCEDEST_CHECK}" != 'False' ]] || [[ "${SOURCEDEST_CHECK}" != 'false' ]]; then
        log "Setting SourceDestCheck to false for eni: ${eni}"
        aws ec2 modify-network-interface-attribute --network-interface-id "${eni}" --no-source-dest-check --region "${REGION}" ||
            die "Unable to set SourceDestCheck to false"
    fi
done

log "Configuration of iptables for NAT/PAT complete."
